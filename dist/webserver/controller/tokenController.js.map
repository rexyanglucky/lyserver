{"version":3,"sources":["../../../src/webserver/controller/tokenController.js"],"names":["controller","bll","Bll","token","accessToken","code","expire","getTime","Date","jsapi_ticket","getshareconfig","req","res","router","url","param","writeHead","end","JSON","stringify","data","timeStamp","parseInt","noncestr","appid","appSecret","getSignature","then","result","timestamp","nonceStr","signature","appId","getJsapiTicket","Promise","resolve","reject","now","getAccesssToken","jsapiTicketUrl","https","get","treq","tres","on","parse","ticket","expires_in","err","accessTokenUrl","access_token","signValue","sha1","crypto","createHash","update","digest","catch","module","exports"],"mappings":"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","file":"tokenController.js","sourcesContent":["import { default as Bll } from \"../../bll/article\";\r\nimport { Stream } from \"stream\";\r\nimport path from 'path';\r\nimport FileHelper from \"../../common/file\";\r\nimport https from \"https\";\r\nimport crypto from \"crypto\";\r\n\r\n\r\nlet controller = {\r\n    bll: new Bll(),\r\n    token: { accessToken: { code: '', expire: 7200, getTime: new Date() }, jsapi_ticket: { code: '', expire: 7200, getTime: new Date() } },\r\n    getshareconfig(req, res, router) {\r\n        let url = router.param.url;\r\n        if (!url) {\r\n            res.writeHead(200, { 'Content-Type': 'text/plain;charset:utf-8' });\r\n            res.end(JSON.stringify({ code: 2, data: '参数错误' }));\r\n            return false;\r\n        }\r\n        let timeStamp =parseInt(new Date().getTime()/1000);\r\n        let noncestr = \"xiaoliangyu\";\r\n        // let appid = 'wx932146c9470bf79c';\r\n        // let appSecret = 'a60a48b54ad07a20e8d67fa070e8632e';\r\n        let appid = 'wx5be5cfaafdd810b4';\r\n        let appSecret = 'd4624c36b6795d1d99dcf0547af5443d';\r\n        \r\n        this.getSignature(appid, appSecret, noncestr, timeStamp, url).then((data) => {\r\n            let result = { timestamp: timeStamp, nonceStr: noncestr, signature: data, appId: appid };\r\n            res.writeHead(200, { 'Content-Type': 'text/plain;charset:utf-8' });\r\n            res.end(JSON.stringify({ code: 1, data: result }));\r\n        });\r\n\r\n    },\r\n    getJsapiTicket(appid, appSecret) {\r\n        return new Promise((resolve, reject) => {\r\n            let now = new Date();\r\n            let token = this.token;\r\n            if (token.jsapi_ticket.code && token.jsapi_ticket.getTime.getTime() + token.jsapi_ticket.expire * 1000 >= now.getTime()) {\r\n                resolve(token.jsapi_ticket.code);\r\n            }\r\n            else {\r\n                this.getAccesssToken(appid, appSecret).then((code) => {\r\n                    let jsapiTicketUrl = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${code}&type=jsapi`;\r\n                    https.get(jsapiTicketUrl, function (treq, tres) {\r\n                        let result = '';\r\n                        treq.on('data', function (data) {\r\n                            result += data;\r\n                        });\r\n                        treq.on('end', function () {\r\n                            if ((typeof (result)) === \"string\") {\r\n                                result = JSON.parse(result);\r\n                            }\r\n                            token.jsapi_ticket.code = result.ticket;\r\n                            token.jsapi_ticket.expire = result.expires_in;\r\n                            token.jsapi_ticket.getTime = new Date();\r\n                            resolve(token.jsapi_ticket.code);\r\n\r\n                        });\r\n                        treq.on('error', function (err) {\r\n                            reject(err);\r\n                        })\r\n                    });\r\n                })\r\n\r\n\r\n            }\r\n        })\r\n\r\n\r\n    },\r\n    getAccesssToken(appId, appSecret) {\r\n        let token = this.token;\r\n        return new Promise((resolve, reject) => {\r\n            // let accessTokenUrl = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=wx932146c9470bf79c&secret=a60a48b54ad07a20e8d67fa070e8632e`;\r\n            let accessTokenUrl = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appId}&secret=${appSecret}`;\r\n            let now = new Date();\r\n            if (token.accessToken.code && token.accessToken.getTime.getTime() + token.accessToken.expire * 1000 >= now.getTime()) {\r\n                resolve(token.accessToken.code)\r\n            }\r\n            else {\r\n                https.get(accessTokenUrl, function (treq, tres) {\r\n                    let result = '';\r\n                    treq.on('data', function (data) {\r\n                        result += data;\r\n                    });\r\n                    treq.on('end', function () {\r\n                        if ((typeof (result)) === \"string\") {\r\n                            result = JSON.parse(result);\r\n                        }\r\n                        token.accessToken.code = result.access_token;\r\n                        token.accessToken.expire = result.expires_in;\r\n                        token.accessToken.getTime = new Date();\r\n                        resolve(token.accessToken.code)\r\n\r\n                    });\r\n                    treq.on('error', function (err) {\r\n                        reject(err);\r\n                    })\r\n                });\r\n            }\r\n        })\r\n\r\n\r\n    },\r\n    getSignature(appid, appSecret, nonceStr, timeStamp, url) {\r\n        return new Promise((resolve, reject) => {\r\n            this.getJsapiTicket(appid, appSecret).then((jsapi_ticket) => {\r\n                let signValue = \"jsapi_ticket=\" + jsapi_ticket + \"&noncestr=\" + nonceStr + \"&timestamp=\" + timeStamp + \"&url=\" + url;\r\n                let sha1 = crypto.createHash('sha1');\r\n                sha1.update(signValue);\r\n                let signature = sha1.digest('hex');\r\n                resolve(signature);\r\n            }).catch((err) => { reject(err); });\r\n        })\r\n    }\r\n\r\n\r\n\r\n}\r\n// controller.propotype.token={ accessToken: { code: '', expire: 7200, getTime: new Date() }, jsapi_ticket: { code: '', expire: 7200, getTime: new Date() } };\r\nmodule.exports = controller;"]}