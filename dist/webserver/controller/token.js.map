{"version":3,"sources":["../../../src/webserver/controller/token.js"],"names":["controller","bll","token","accessToken","code","expire","getTime","Date","jsapi_ticket","getjsapiticket","req","res","router","now","end","JSON","stringify","data","getAccesssToken","then","jsapiTicketUrl","get","result","on","parse","ticket","expires_in","err","Promise","resolve","reject","accessTokenUrl","access_token","module","exports"],"mappings":"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","file":"token.js","sourcesContent":["import { default as Bll } from \"../../bll/article\";\r\nimport { Stream } from \"stream\";\r\nimport path from 'path';\r\nimport FileHelper from \"../../common/file\";\r\nimport http from \"http\"\r\nlet controller = {\r\n    bll: new Bll(),\r\n    token: { accessToken: { code: '', expire: 7200, getTime: new Date() }, jsapi_ticket: { code: '', expire: 7200, getTime: new Date() } },\r\n    getjsapiticket(req, res, router) {\r\n\r\n        let now = new Date();\r\n        if (token.jsapi_ticket.code && token.jsapi_ticket.getTime.getTime() + expire * 1000 <= now.getTime()) {\r\n            res.end(JSON.stringify({ code: 1, data: token.jsapi_ticket.code }));\r\n        }\r\n        else {\r\n            this.getAccesssToken().then((code) => {\r\n                let jsapiTicketUrl = `https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=${code}&type=jsapi`;\r\n                http.get(jsapiTicketUrl, function (req, res) {\r\n                    let result = '';\r\n                    req.on('data', function (data) {\r\n                        result += data;\r\n                    });\r\n                    req.on('end', function () {\r\n                        if ((typeof (result)) === \"string\") {\r\n                            result = JSON.parse(result);\r\n                        }\r\n                        token.accessToken.code = result.ticket;\r\n                        token.accessToken.expire = result.expires_in;\r\n                        res.end(JSON.stringify({ code: 1, data: token.jsapi_ticket.code }));\r\n                    });\r\n                    req.on('error',function(err){\r\n                        res.end(JSON.stringify({ code: 0, data: err }));\r\n                    })\r\n                });\r\n            })\r\n\r\n\r\n        }\r\n\r\n    },\r\n    getAccesssToken() {\r\n        return new Promise((resolve, reject) => {\r\n            let accessTokenUrl = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=wx932146c9470bf79cAPPID&secret=a60a48b54ad07a20e8d67fa070e8632e`;\r\n            let now = new Date();\r\n            if (token.accessToken.code && token.accessToken.getTime.getTime() + expire * 1000 <= now.getTime()) {\r\n                resolve(token.accessToken.code)\r\n            }\r\n            else {\r\n                http.get(accessTokenUrl, function (req, res) {\r\n                    let result = '';\r\n                    req.on('data', function (data) {\r\n                        result += data;\r\n                    });\r\n                    req.on('end', function () {\r\n                        if ((typeof (result)) === \"string\") {\r\n                            result = JSON.parse(result);\r\n                        }\r\n                        token.accessToken.code = result.access_token;\r\n                        token.accessToken.expire = result.expires_in;\r\n                        resolve(token.accessToken.code)\r\n\r\n                    });\r\n                    req.on('error', function (err) {\r\n                        reject(err);\r\n                    })\r\n                });\r\n            }\r\n        })\r\n\r\n\r\n    }\r\n\r\n\r\n}\r\nmodule.exports = controller;"]}