{"version":3,"sources":["../../../src/webserver/controller/articleController.js"],"names":["articleController","bll","Bll","add","req","res","router","param","createTime","Date","toUTCString","updateTime","files","length","promiseList","map","item","index","arr","FileHelper","WriteFile","then","url","name","self","Promise","all","saveArticle","result","code","data","catch","err","stack","addDraft","saveArticleDraft","detial","id","getArticle","public","publicArticle","draftDetial","getArticleDraft","list","getArticleList","content","replace","substr","draftlist","getArticleDraftList","historylist","getArticleHistoryList","delete","delArticle","update","updateArticle","module","exports"],"mappings":"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","file":"articleController.js","sourcesContent":["import { default as Bll } from \"../../bll/articleV2\";\r\nimport { Stream } from \"stream\";\r\nimport path from 'path';\r\nimport FileHelper from \"../../common/file\";\r\nimport {jsonResult} from \"../../common/jsonResult\"\r\n/** @namespace  */\r\nlet articleController = {\r\n    bll: new Bll(),\r\n\r\n\r\n    /**\r\n     * 添加文章\r\n     * @param {*} req \r\n     * @param {*} res \r\n     * @param {*} router \r\n     * @param {Object} param \r\n     * {content:{type:string,desc:'内容'},\r\n     * title:{type:string,desc:'标题'},\r\n     * headImg:{type:[blob],desc:'图片'},\r\n     * isMD:{type:boolean,desc:'是否是markdown'}}\r\n     * @returns {object} {code:1,data:result}\r\n     */\r\n    add(req, res, router) {\r\n        let param = router.param;\r\n        param.createTime = new Date().toUTCString();\r\n        param.updateTime = new Date().toUTCString();\r\n        if (router.files && router.files.length > 0) {\r\n            let promiseList = router.files.map((item, index, arr) => {\r\n                return FileHelper.WriteFile(item).then((url) => {\r\n                    param[item.name] = url;\r\n                })\r\n            });\r\n            let self = this;\r\n            Promise.all(promiseList).then(() => {\r\n                self.bll.saveArticle(\r\n                    (result) => {\r\n                        jsonResult(res, { code: 1, data: result })\r\n                    },\r\n                    param\r\n                );\r\n            }).catch(err => {\r\n\r\n                jsonResult(res, { code: 4, data: err.stack })\r\n            })\r\n        }\r\n        else {\r\n            this.bll.saveArticle(\r\n                (result) => {\r\n\r\n                    jsonResult(res, { code: 1, data: result })\r\n                },\r\n                param\r\n            );\r\n        }\r\n    },\r\n    /**\r\n   * 添加文章\r\n   * @param {*} req \r\n   * @param {*} res \r\n   * @param {*} router \r\n   * @param {Object} param \r\n   * {content:{type:string,desc:'内容'},\r\n   * title:{type:string,desc:'标题'},\r\n   * headImg:{type:[blob],desc:'图片'},\r\n   * isMD:{type:boolean,desc:'是否是markdown'}}\r\n   * @returns {object} {code:1,data:result}\r\n   */\r\n    addDraft(req, res, router) {\r\n        let param = router.param;\r\n        param.createTime = new Date().toUTCString();\r\n        param.updateTime = new Date().toUTCString();\r\n        if (router.files && router.files.length > 0) {\r\n            let promiseList = router.files.map((item, index, arr) => {\r\n                return FileHelper.WriteFile(item).then((url) => {\r\n                    param[item.name] = url;\r\n                })\r\n            });\r\n            let self = this;\r\n            Promise.all(promiseList).then(() => {\r\n                self.bll.saveArticleDraft(param).then(\r\n                    (result) => {\r\n                        jsonResult(res, { code: 1, data: result })\r\n                    }\r\n                )\r\n            }).catch(err => {\r\n                jsonResult(res, { code: 4, data: err.stack })\r\n            })\r\n        }\r\n        else {\r\n            this.bll.saveArticleDraft(param).then(\r\n                (result) => {\r\n                    jsonResult(res, { code: 1, data: result })\r\n                }\r\n            ).catch(err => {\r\n                jsonResult(res, { code: 4, data: err.stack })\r\n            })\r\n        }\r\n    },\r\n    /**\r\n   * 获取文章详情\r\n   * @param {*} req \r\n   * @param {*} res \r\n   * @param {*} router \r\n   * @param {string} id 文章ID\r\n   * @returns {object} \r\n   * {content:{type:string,desc:'内容'},\r\n   * title:{type:string,desc:'标题'},\r\n   * headImg:{type:[blob],desc:'图片'},\r\n   * isMD:{type:boolean,desc:'是否是markdown'}}\r\n   */\r\n    detial(req, res, router) {\r\n        let id = router.param.id;\r\n        this.bll.getArticle(id).then(result => {\r\n            jsonResult(res, { code: 1, data: result })\r\n        });\r\n    },\r\n    /**\r\n     * 发布文章\r\n     * @param {*} req \r\n     * @param {*} res \r\n     * @param {*} router \r\n     */\r\n    public(req, res, router) {\r\n        let id = router.param.id;\r\n        this.bll.publicArticle(id).then(result => {\r\n            jsonResult(res, { code: 1, data: result });\r\n        }).catch(err => {\r\n            jsonResult(res, { code: 4, data: err.stack })\r\n        })\r\n    },\r\n    /**\r\n     * 获取草稿箱文章详情\r\n     * @param {*} req \r\n     * @param {*} res \r\n     * @param {*} router \r\n     */\r\n    draftDetial(req, res, router) {\r\n        let id = router.param.id;\r\n        this.bll.getArticleDraft(id).then(result => {\r\n            jsonResult(res, { code: 1, data: result })\r\n        });\r\n    },\r\n    /**\r\n * 获取文章列表\r\n * @param {*} req \r\n * @param {*} res \r\n * @param {*} router \r\n * @returns {object} {code:1,data:result}\r\n */\r\n    list(req, res, router) {\r\n        let param = router.param;\r\n        this.bll.getArticleList(param).then(\r\n            (result) => {\r\n                let content = result.content ? result.content.replace(/<\\/?.+?>/g, \"\") : \"\";\r\n                content = content.length > 100 ? content.substr(0, 100) + '...' : content;\r\n                jsonResult(res, { code: 1, data: result })\r\n            }\r\n        );\r\n\r\n    },\r\n       /**\r\n * 获取草稿箱文章列表\r\n * @param {*} req \r\n * @param {*} res \r\n * @param {*} router \r\n * @returns {object} {code:1,data:result}\r\n */\r\ndraftlist(req, res, router) {\r\n    let param = router.param;\r\n    this.bll.getArticleDraftList(param).then(\r\n        (result) => {\r\n            let content = result.content ? result.content.replace(/<\\/?.+?>/g, \"\") : \"\";\r\n            content = content.length > 100 ? content.substr(0, 100) + '...' : content;\r\n            jsonResult(res, { code: 1, data: result })\r\n        }\r\n    );\r\n\r\n},\r\n      /**\r\n * 获取历史文章列表 统计还原用\r\n * @param {*} req \r\n * @param {*} res \r\n * @param {*} router \r\n * @returns {object} {code:1,data:result}\r\n */\r\nhistorylist(req, res, router) {\r\n    let param = router.param;\r\n    this.bll.getArticleHistoryList(param).then(\r\n        (result) => {\r\n            let content = result.content ? result.content.replace(/<\\/?.+?>/g, \"\") : \"\";\r\n            content = content.length > 100 ? content.substr(0, 100) + '...' : content;\r\n            jsonResult(res, { code: 1, data: result })\r\n        }\r\n    );\r\n\r\n},\r\n    /**\r\n * 删除文章\r\n * @param {*} req \r\n * @param {*} res \r\n * @param {*} router \r\n * @param {string} id 文章ID\r\n */\r\n    delete(req, res, router) {\r\n        let id = router.param.id;\r\n        this.bll.delArticle(id).then(result => {\r\n            jsonResult(res, { code: 1, data: result })\r\n        });\r\n    },\r\n    /**\r\n     * 更新文档 点击更新时触发\r\n     * @param {*} req \r\n     * @param {*} res \r\n     * @param {*} router \r\n     */\r\n    update(req,res,router){\r\n        let id=router.param.id;\r\n        this.bll.updateArticle(id).then(result=>{\r\n            jsonResult(res, { code: 1, data: result })\r\n        })\r\n    }\r\n\r\n    \r\n}\r\nmodule.exports = articleController;"]}