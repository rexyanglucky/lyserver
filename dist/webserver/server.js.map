{"version":3,"sources":["../../src/webserver/server.js"],"names":["http","require","url","fs","p","querystring","Router","MIME","createServer","req","res","path","parse","fpath","join","__dirname","exists","r","t","substring","lastIndexOf","toLowerCase","setHtml","setFile","setHeader","router","method","purl","param","query","resolveUrl","redirectAction","arr","on","d","push","console","log","data","Buffer","concat","toString","ret","headers","indexOf","boundaryArr","split","boundary","formItemArr","objList","map","item","index","reg","obj","name","filename","Content","carr","cdisc","replace","matchstr","contentDisposition","filenameValue","fileType","starIndex","sourceString","splice","cvalue","substr","length","files","JSON","err","body","writeHead","end","listen","readFile","hasOwnProperty","readFileSync","sleep","sleepTime","start","Date"],"mappings":"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","file":"server.js","sourcesContent":["var http = require('http');\r\nvar url = require(\"url\");//url模块\r\nvar fs = require(\"fs\");//文件系统模块\r\nvar p = require(\"path\");//路径\r\nvar querystring = require(\"querystring\");//参数  \r\nvar Router = require(\"./router\");//自定义路由\r\n\r\nvar MIME = {\r\n    \"css\": \"text/css\",\r\n    \"gif\": \"image/gif\",\r\n    \"html\": \"text/html\",\r\n    \"ico\": \"image/x-icon\",\r\n    \"jpeg\": \"image/jpeg\",\r\n    \"jpg\": \"image/jpeg\",\r\n    \"js\": \"text/javascript\",\r\n    \"json\": \"application/json\",\r\n    \"pdf\": \"application/pdf\",\r\n    \"png\": \"image/png\",\r\n    \"svg\": \"image/svg+xml\",\r\n    \"swf\": \"application/x-shockwave-flash\",\r\n    \"tiff\": \"image/tiff\",\r\n    \"txt\": \"text/plain\",\r\n    \"wav\": \"audio/x-wav\",\r\n    \"wma\": \"audio/x-ms-wma\",\r\n    \"wmv\": \"video/x-ms-wmv\",\r\n    \"xml\": \"text/xml\",\r\n    \"htc\": \"text/x-component\",\r\n    \"svg\": \"image/svg+xml\"\r\n}\r\nhttp.createServer(function (req, res) {\r\n    if (req.url != \"/favicon.ico\") {\r\n        var path = url.parse(req.url).path;\r\n        if (path == \"/\") {\r\n            path = \"/index.html\";\r\n        }\r\n        var fpath = p.join(__dirname, path);\r\n        fs.exists(fpath, function (r) {\r\n            if (r) {\r\n                var t = fpath.substring(fpath.lastIndexOf(\".\") + 1).toLowerCase();\r\n                switch (t) {\r\n                    case \"html\":\r\n                    case \"htc\":\r\n                        setHtml(fpath, req, res);\r\n                        break;\r\n                    default:\r\n                        setFile(fpath, req, res);\r\n                        break;\r\n                }\r\n\r\n            }\r\n            else {\r\n                //todo 可为每个请求创建单独的上下文存储路由相关信息，目前暂且使用全局router\r\n                //可测试多个请求下router值变化问题\r\n                res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n                // res.setHeader(\"Content-Type\", \"application/json;charset=utf-8\");\r\n                var router = new Router();\r\n                if (req.method === \"GET\") {\r\n                    let purl = url.parse(req.url);\r\n                    router.param = querystring.parse(purl.query);\r\n                    router.resolveUrl(req.url);\r\n                    router.redirectAction(req, res);\r\n                }\r\n                else if (req.method === \"POST\") {\r\n                    var arr = [];\r\n                    req.on(\"data\", (d) => { arr.push(d);console.log(d); });\r\n                    req.on(\"end\", () => {\r\n                        let data = Buffer.concat(arr).toString(), ret;\r\n                        //判断请求是否包含文件\r\n                        //TODO 接收大文件时，一次性存入内存性能太低\r\n                        if (req.headers['content-type'].indexOf('multipart/form-data') > -1) {\r\n                            // let contentType = req.headers['content-type'].split(';');\r\n                            let boundaryArr = req.headers['content-type'].split(';')[1].split('=');\r\n                            let boundary = '--' + boundaryArr[1];\r\n                            let formItemArr = data.split(boundary);\r\n                            let objList = formItemArr.map((item, index, arr) => {\r\n                                let reg = /Content-Disposition: (form-data); name=\"(\\S+)\"(?:; (filename)=\"(\\S+[.]\\S{3,4})\"\\s+Content-Type: (\\S+))?/gi\r\n                                // item.replace(/Content-Disposition: (form-data); name=\"(\\s+)\"; (filename)=\"(\\s+[.]\\s{3-4})\"/)\r\n                                let obj = { name: null, 'Content-Disposition': null, filename: null, 'Content-Type': null, Content: null };\r\n                                let carr = item.split('\\r\\n\\r\\n');\r\n                                let cdisc = carr[0];\r\n                                cdisc.replace(reg, function (matchstr, contentDisposition, name, filename, filenameValue, fileType, starIndex, sourceString) {\r\n                                    obj.name = name;\r\n                                    obj['Content-Disposition'] = contentDisposition;\r\n                                    obj[filename] = filenameValue;\r\n                                    obj['Content-Type'] = fileType;\r\n                                })\r\n                                carr.splice(0, 1);\r\n                                let cvalue = carr.join('');\r\n                                obj.Content = cvalue.substr(0, cvalue.length - '\\r\\n'.length);\r\n                                return obj;\r\n                            })\r\n                            console.log(objList);\r\n                            router.files = [];\r\n                            objList.map((item, index, arr) => {\r\n                                if (item.name) {\r\n                                    if (item.filename) {\r\n                                        router.files.push(item);\r\n                                    }\r\n                                    else {\r\n                                        router.param[item.name] = item.Content;\r\n                                    }\r\n                                }\r\n                            })\r\n\r\n\r\n                        }\r\n                        else {\r\n                            try {\r\n                                ret = JSON.parse(data);\r\n                            } catch (err) { }\r\n                            req.body = ret;\r\n                            router.param = ret;\r\n                        }\r\n                        router.resolveUrl(req.url);\r\n                        router.redirectAction(req, res);\r\n                    })\r\n                }\r\n                else if (req.method === \"OPTIONS\") {\r\n                    res.setHeader(\"Access-Control-Allow-Methods\", \"PUT,POST,GET,DELETE,OPTIONS\");\r\n                    res.setHeader(\"Access-Control-Allow-Headers\", \"X-Requested-With, accept, origin, content-type\");\r\n                    res.setHeader(\"X-Powered-By\", ' 3.2.1');\r\n                    res.writeHead(200, { 'Content-Type': 'text/plain;charset:utf-8' });\r\n                    res.end(\"OPTIONS\");\r\n                }\r\n\r\n            }\r\n\r\n        });\r\n\r\n    }\r\n    else {\r\n        res.writeHead(200);\r\n        res.end(\"favicon.ico\");\r\n    }\r\n\r\n}).listen(8001);\r\nconsole.log(\"http://127.0.0.1:8001\");\r\n/**\r\n * 设置html\r\n * @param {String} 文件路径 \r\n * @param {req} request \r\n * @param {res} response \r\n */\r\nfunction setHtml(path, req, res) {\r\n    fs.readFile(path, function (err, data) {\r\n        if (err) {\r\n            res.writeHead(500, { 'Content-Type': 'text/plain;charset:utf-8' });\r\n            res.end(\"加载文件失败\");\r\n        }\r\n        else {\r\n            var t = path.substring(path.lastIndexOf(\".\") + 1);\r\n            if (MIME.hasOwnProperty(t)) {\r\n                res.writeHead(200, { 'Content-Type': MIME[t] });\r\n                res.end(data.toString());\r\n            }\r\n            else {\r\n                res.writeHead(200, { 'Content-Type': 'text/plain;charset:utf-8' });\r\n                res.end(\"文件类型错误\" + t);\r\n            }\r\n        }\r\n\r\n    })\r\n}\r\n/**\r\n * 处理二进制文件\r\n * @param {String} path \r\n * @param {req} req \r\n * @param {res} res \r\n */\r\nfunction setFile(path, req, res) {\r\n    var data = fs.readFileSync(path, \"binary\");\r\n    var t = path.substring(path.lastIndexOf(\".\") + 1);\r\n    if (MIME.hasOwnProperty(t)) {\r\n        res.writeHead(200, { 'Content-Type': MIME[t] });\r\n        res.end(data, \"binary\");\r\n    }\r\n    else {\r\n        res.writeHead(200, { 'Content-Type': 'text/plain;charset:utf-8' });\r\n        res.end(\"文件类型错误\" + t);\r\n    }\r\n}\r\n\r\nfunction sleep(sleepTime) {\r\n    for (var start = +new Date; +new Date - start <= sleepTime;) { }\r\n}\r\n"]}